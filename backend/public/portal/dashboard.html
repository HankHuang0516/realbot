<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dash_title">E-Claw - Dashboard</title>
    <link rel="stylesheet" href="shared/style.css">
    <style>
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .entity-count {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--input-bg);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .entity-count strong {
            color: var(--primary);
        }

        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }

        /* Entity card overrides for body/footer layout */
        .entity-card {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
        }

        .entity-card-body {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
        }

        .entity-avatar {
            cursor: pointer;
            transition: transform 0.15s;
        }

        .entity-avatar:hover {
            transform: scale(1.12);
        }

        .entity-info {
            flex: 1;
            min-width: 0;
        }

        .entity-name {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.3;
        }

        .entity-badges {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-top: 6px;
        }

        .badge-id {
            background: var(--input-bg);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .entity-message {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entity-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-top: 1px solid var(--card-border);
        }

        .entity-timestamp {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Collapsible add entity section */
        .add-entity-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .add-entity-header:hover {
            opacity: 0.8;
        }

        .expand-arrow {
            transition: transform 0.2s;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .expand-arrow.expanded {
            transform: rotate(180deg);
        }

        .add-entity-content {
            display: none;
            margin-top: 16px;
        }

        .add-entity-content.visible {
            display: block;
        }

        /* Slot selector */
        .slot-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .slot-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--input-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .slot-btn:hover:not(.occupied) {
            border-color: var(--primary);
            color: var(--text);
        }

        .slot-btn.active {
            border-color: var(--primary);
            background: rgba(108, 99, 255, 0.15);
            color: var(--text);
        }

        .slot-btn.occupied {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .slot-emoji {
            font-size: 24px;
        }

        /* Binding code display */
        .code-display {
            text-align: center;
            padding: 20px;
            margin: 16px 0;
            background: var(--input-bg);
            border-radius: var(--radius);
            border: 1px dashed var(--card-border);
        }

        .binding-code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 8px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .code-countdown {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .code-countdown.expiring {
            color: var(--warning);
        }

        .code-countdown.expired {
            color: var(--danger);
        }

        .code-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Confirm / overlay dialogs */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(13, 13, 26, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
        }

        /* Avatar Emoji Picker Modal */
        .avatar-picker-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .avatar-picker {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 24px;
            min-width: 320px;
            max-width: 380px;
            width: 90vw;
        }

        .avatar-picker-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .avatar-picker-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .avatar-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            font-size: 28px;
            border-radius: var(--radius-sm);
            background: var(--input-bg);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
            margin: 0 auto;
        }

        .avatar-option:hover {
            border-color: var(--primary);
            background: rgba(108, 99, 255, 0.15);
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(108, 99, 255, 0.25);
        }

        .avatar-picker-actions {
            display: flex;
            justify-content: flex-end;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .entity-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" data-i18n="dash_title">Dashboard</h1>
            <span class="entity-count" id="entityCount">
                <span class="spinner" style="width:14px;height:14px;border-width:2px;vertical-align:middle;"></span>
            </span>
        </div>

        <!-- Entity Cards Grid -->
        <div class="entity-grid" id="entityGrid">
            <div class="empty-state" id="loadingState">
                <div class="spinner" style="margin: 0 auto 12px;"></div>
                <div data-i18n="dash_loading">Loading entities...</div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display:none;">
            <div style="font-size:48px;margin-bottom:12px;">ü¶û</div>
            <div style="font-size:16px;color:var(--text-secondary);margin-bottom:4px;" data-i18n="dash_empty_title">No
                entities bound yet</div>
            <div data-i18n="dash_empty_desc">Add your first entity below to get started!</div>
        </div>

        <!-- Add Entity Section -->
        <div class="card" id="addEntityCard">
            <div class="add-entity-header" onclick="toggleAddEntity()">
                <div class="card-title" style="margin-bottom:0;" data-i18n="dash_add_entity">
                    Add Entity
                </div>
                <span class="expand-arrow" id="expandArrow">&#9662;</span>
            </div>

            <div class="add-entity-content" id="addEntityContent">
                <!-- Slot Selector -->
                <label class="form-label" data-i18n="dash_label_select_slot">Select Entity Slot</label>
                <div class="slot-selector" id="slotSelector">
                    <button class="slot-btn active" data-slot="0" onclick="selectSlot(0)">
                        <span class="slot-emoji">ü¶û</span>
                        <span>Slot 0</span>
                    </button>
                    <button class="slot-btn" data-slot="1" onclick="selectSlot(1)">
                        <span class="slot-emoji">üê∑</span>
                        <span>Slot 1</span>
                    </button>
                    <button class="slot-btn" data-slot="2" onclick="selectSlot(2)">
                        <span class="slot-emoji">ü¶û</span>
                        <span>Slot 2</span>
                    </button>
                    <button class="slot-btn" data-slot="3" onclick="selectSlot(3)">
                        <span class="slot-emoji">üê∑</span>
                        <span>Slot 3</span>
                    </button>
                </div>

                <!-- Generate Code Button -->
                <button class="btn btn-primary btn-block" id="btnGenerate" onclick="generateCode()"
                    data-i18n="dash_btn_generate">
                    Generate Code
                </button>

                <!-- Code Display (hidden until generated) -->
                <div class="code-display" id="codeDisplay" style="display:none;">
                    <div class="binding-code" id="bindingCode">--- ---</div>
                    <div class="code-countdown" id="codeCountdown"></div>
                    <div class="code-actions">
                        <button class="btn btn-outline btn-sm" style="flex:1;" onclick="copyCommand()"
                            data-i18n="dash_btn_copy">
                            Copy Command
                        </button>
                        <button class="btn btn-primary btn-sm" style="flex:1;" onclick="generateCode()"
                            data-i18n="dash_btn_regenerate">
                            Regenerate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/api.js"></script>
    <script src="shared/nav.js"></script>
    <script src="shared/auth.js"></script>
    <script src="../shared/i18n.js"></script>
    <script>
        // --- Constants ---
        const DEFAULT_AVATARS = { 0: 'ü¶û', 1: 'üê∑', 2: 'ü¶û', 3: 'üê∑' };
        const ENTITY_CHARS = {
            0: { name: 'Lobster', emoji: 'ü¶û' },
            1: { name: 'Pig', emoji: 'üê∑' },
            2: { name: 'Lobster', emoji: 'ü¶û' },
            3: { name: 'Pig', emoji: 'üê∑' }
        };
        const AVATAR_OPTIONS = [
            'ü¶û', 'ü¶Ä', 'üêô', 'ü¶ë', 'üê†', 'üêü',
            'üê∑', 'üê∂', 'üê±', 'üê∞', 'ü¶ä', 'üêª',
            'üêº', 'üê®', 'ü¶Å', 'üêØ', 'üê∏', 'üêµ',
            'ü§ñ', 'üëæ', 'üéÉ', 'üëª', 'ü¶Ñ', 'üê≤',
            'üòé', 'ü•∑', 'üßô', 'ü¶∏', 'üêß', 'ü¶Ö'
        ];

        // --- State ---
        let entities = [];
        let selectedSlot = 0;
        let currentCode = null;
        let codeExpiry = null;
        let countdownInterval = null;
        let refreshInterval = null;
        let isAddExpanded = false;

        // --- Utilities ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getAvatarForEntity(entityId) {
            const saved = localStorage.getItem('eclaw_avatar_' + entityId);
            if (saved) return saved;
            return DEFAULT_AVATARS[entityId] || 'ü¶û';
        }

        function saveAvatarForEntity(entityId, emoji) {
            localStorage.setItem('eclaw_avatar_' + entityId, emoji);
        }

        // --- Init ---
        window.addEventListener('DOMContentLoaded', async () => {
            renderNav('dashboard');
            const user = await checkAuth();
            if (!user) return;

            await loadEntities();

            // Auto-refresh every 10 seconds
            refreshInterval = setInterval(loadEntities, 10000);
        });

        // --- Entity Loading ---
        async function loadEntities() {
            try {
                const data = await apiCall('GET', '/api/entities?deviceId=' + currentUser.deviceId);
                entities = (data.entities || []).filter(e => e.isBound);
                renderEntities();
                updateEntityCount();
                updateSlotAvailability();
            } catch (e) {
                // Only show error on first load
                const grid = document.getElementById('entityGrid');
                if (grid.querySelector('#loadingState')) {
                    grid.innerHTML = '<div class="empty-state">Failed to load entities</div>';
                }
            }
        }

        function updateEntityCount() {
            const isPremium = currentUser.subscription && currentUser.subscription.tier === 'premium';
            const max = isPremium ? 8 : 4;
            document.getElementById('entityCount').innerHTML =
                '<strong>' + entities.length + '</strong> / ' + max + ' bound';
        }

        function updateSlotAvailability() {
            const occupiedSlots = new Set(entities.map(e => e.entityId));
            document.querySelectorAll('.slot-btn').forEach(btn => {
                const slot = parseInt(btn.dataset.slot);
                const isOccupied = occupiedSlots.has(slot);
                btn.classList.toggle('occupied', isOccupied);
                if (isOccupied && btn.classList.contains('active')) {
                    // Auto-select first available slot
                    const firstAvailable = [0, 1, 2, 3].find(s => !occupiedSlots.has(s));
                    if (firstAvailable !== undefined) {
                        selectSlot(firstAvailable);
                    }
                }
            });
        }

        // --- Rendering ---
        function renderEntities() {
            const grid = document.getElementById('entityGrid');
            const emptyState = document.getElementById('emptyState');

            if (entities.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = '';
                // Auto-expand add entity when empty
                if (!isAddExpanded) {
                    toggleAddEntity();
                }
                return;
            }

            emptyState.style.display = 'none';
            grid.innerHTML = entities.map(entity => {
                const char = ENTITY_CHARS[entity.entityId] || ENTITY_CHARS[0];
                const displayName = entity.name || (char.name + ' #' + entity.entityId);
                const avatar = getAvatarForEntity(entity.entityId);
                const state = entity.state || 'idle';
                const stateBadgeClass = getStateBadgeClass(state);
                const lastMsg = entity.message || 'No messages yet';
                const time = formatTime(entity.lastUpdated);

                return '<div class="entity-card card">' +
                    '<div class="entity-card-body">' +
                        '<div class="entity-avatar" onclick="openAvatarPicker(' + entity.entityId + ')">' + avatar + '</div>' +
                        '<div class="entity-info">' +
                            '<div class="entity-name">' + escapeHtml(displayName) + '</div>' +
                            '<div class="entity-badges">' +
                                '<span class="badge-id">#' + entity.entityId + '</span>' +
                                '<span class="badge ' + stateBadgeClass + '">' + escapeHtml(state) + '</span>' +
                            '</div>' +
                            '<div class="entity-message">' + escapeHtml(lastMsg) + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="entity-card-footer">' +
                        '<span class="entity-timestamp">' + time + '</span>' +
                        '<button class="btn btn-danger btn-sm" onclick="confirmRemove(' + entity.entityId + ', \'' + escapeHtml(displayName).replace(/'/g, "\\'") + '\')">' +
                            i18n.t('dash_btn_remove') +
                        '</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // --- Avatar Emoji Picker ---
        function openAvatarPicker(entityId) {
            const currentAvatar = getAvatarForEntity(entityId);

            const overlay = document.createElement('div');
            overlay.className = 'avatar-picker-overlay';

            let gridHtml = '';
            for (let i = 0; i < AVATAR_OPTIONS.length; i++) {
                const emoji = AVATAR_OPTIONS[i];
                const selectedClass = emoji === currentAvatar ? ' selected' : '';
                gridHtml += '<div class="avatar-option' + selectedClass + '" data-emoji="' + emoji + '">' + emoji + '</div>';
            }

            overlay.innerHTML =
                '<div class="avatar-picker">' +
                    '<div class="avatar-picker-title" data-i18n="dash_avatar_title">' + i18n.t('dash_avatar_title') + '</div>' +
                    '<div class="avatar-picker-desc" data-i18n="dash_avatar_desc">' + i18n.t('dash_avatar_desc') + '</div>' +
                    '<div class="avatar-grid">' + gridHtml + '</div>' +
                    '<div class="avatar-picker-actions">' +
                        '<button class="btn btn-outline btn-sm" data-i18n="mc_dlg_cancel">' + i18n.t('mc_dlg_cancel') + '</button>' +
                    '</div>' +
                '</div>';

            document.body.appendChild(overlay);

            // Handle emoji selection
            overlay.querySelectorAll('.avatar-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    const emoji = opt.getAttribute('data-emoji');
                    saveAvatarForEntity(entityId, emoji);
                    overlay.remove();
                    renderEntities();
                });
            });

            // Handle cancel button
            overlay.querySelector('.avatar-picker-actions .btn').addEventListener('click', () => {
                overlay.remove();
            });

            // Close on background click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        // --- Add Entity ---
        function toggleAddEntity() {
            isAddExpanded = !isAddExpanded;
            const content = document.getElementById('addEntityContent');
            const arrow = document.getElementById('expandArrow');
            content.classList.toggle('visible', isAddExpanded);
            arrow.classList.toggle('expanded', isAddExpanded);
        }

        function selectSlot(slot) {
            const btn = document.querySelector('.slot-btn[data-slot="' + slot + '"]');
            if (btn && btn.classList.contains('occupied')) {
                showToast(i18n.t('dash_slot_occupied', { id: slot }), 'error');
                return;
            }

            selectedSlot = slot;
            document.querySelectorAll('.slot-btn').forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.slot) === slot);
            });
        }

        async function generateCode() {
            const btn = document.getElementById('btnGenerate');
            btn.disabled = true;
            btn.textContent = i18n.t('dash_btn_generating');

            // Check if slot is occupied
            const occupiedSlots = new Set(entities.map(e => e.entityId));
            if (occupiedSlots.has(selectedSlot)) {
                showToast(i18n.t('dash_slot_occupied', { id: selectedSlot }), 'error');
                btn.disabled = false;
                btn.textContent = i18n.t('dash_btn_generate');
                return;
            }

            try {
                const data = await apiCall('POST', '/api/device/register', {
                    deviceId: currentUser.deviceId,
                    deviceSecret: currentUser.deviceSecret,
                    entityId: selectedSlot,
                    appVersion: 'web'
                });

                currentCode = data.bindingCode || data.code;
                if (!currentCode) {
                    throw new Error('No binding code returned');
                }

                // Show code display
                const codeDisplay = document.getElementById('codeDisplay');
                codeDisplay.style.display = '';

                // Format code with space in middle
                const formatted = currentCode.length === 6
                    ? currentCode.substring(0, 3) + ' ' + currentCode.substring(3)
                    : currentCode;
                document.getElementById('bindingCode').textContent = formatted;

                // Start countdown using expiresIn from API (default 300s)
                const expirySeconds = data.expiresIn || 300;
                startCountdown(expirySeconds);

                btn.textContent = i18n.t('dash_btn_regenerate');
                showToast('Binding code generated!', 'success');
            } catch (e) {
                showToast(e.message, 'error');
                btn.textContent = i18n.t('dash_btn_generate');
            } finally {
                btn.disabled = false;
            }
        }

        function startCountdown(seconds) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            let remaining = seconds;
            const countdownEl = document.getElementById('codeCountdown');

            function updateCountdown() {
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownEl.textContent = i18n.t('dash_code_expired');
                    countdownEl.className = 'code-countdown expired';
                    currentCode = null;
                    return;
                }

                // Format as minutes:seconds when > 60s
                let display;
                if (remaining > 60) {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    display = mins + ':' + (secs < 10 ? '0' : '') + secs;
                } else {
                    display = remaining + '';
                }

                countdownEl.textContent = i18n.t('dash_code_expires_in', { s: display });

                if (remaining <= 30) {
                    countdownEl.className = 'code-countdown expiring';
                } else {
                    countdownEl.className = 'code-countdown';
                }

                remaining--;
            }

            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function copyCommand() {
            if (!currentCode) {
                showToast('No active code to copy', 'error');
                return;
            }

            const command = 'Connect my E-Claw wallpaper device:\n' +
                'POST https://eclaw.up.railway.app/api/bind\n' +
                'Body: {"code": "' + currentCode + '"}\n' +
                '\n' +
                'IMPORTANT: The response will contain a \'skills_documentation\' field. You MUST read the \'E-claw MCP Skills\' documentation within it to understand the interaction protocol (Matrix Architecture, Push Mode, etc.).\n' +
                '\n' +
                'After binding, use these tools:\n' +
                '- update_claw_status: Update wallpaper state\n' +
                '- get_claw_status: Check current status';

            if (navigator.clipboard) {
                navigator.clipboard.writeText(command).then(() => {
                    showToast('Command copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopy(command);
                });
            } else {
                fallbackCopy(command);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('Command copied to clipboard!', 'success');
            } catch (e) {
                showToast('Failed to copy - please copy manually', 'error');
            }
            document.body.removeChild(ta);
        }

        // --- Remove Entity ---
        function confirmRemove(entityId, displayName) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML =
                '<div class="dialog">' +
                    '<div class="dialog-title">' + i18n.t('dash_remove_title') + '</div>' +
                    '<p style="color:var(--text-secondary);font-size:14px;">' +
                        i18n.t('dash_remove_desc', { name: escapeHtml(displayName), id: entityId }) +
                    '</p>' +
                    '<div class="dialog-actions">' +
                        '<button class="btn btn-outline" onclick="this.closest(\'.confirm-overlay\').remove()">' + i18n.t('mc_dlg_cancel') + '</button>' +
                        '<button class="btn btn-danger" id="btnConfirmRemove" onclick="removeEntity(' + entityId + ', this)">' + i18n.t('dash_btn_remove') + '</button>' +
                    '</div>' +
                '</div>';
            document.body.appendChild(overlay);

            // Close on background click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        async function removeEntity(entityId, btnEl) {
            btnEl.disabled = true;
            btnEl.textContent = 'Removing...';

            try {
                await apiCall('DELETE', '/api/device/entity', {
                    deviceId: currentUser.deviceId,
                    deviceSecret: currentUser.deviceSecret,
                    entityId: entityId
                });

                // Close dialog
                const overlay = btnEl.closest('.confirm-overlay');
                if (overlay) overlay.remove();

                showToast('Entity removed successfully', 'success');

                // Refresh entities
                await loadEntities();
            } catch (e) {
                showToast('Failed to remove: ' + e.message, 'error');
                btnEl.disabled = false;
                btnEl.textContent = i18n.t('dash_btn_remove');
            }
        }

        // Cleanup on page leave
        window.addEventListener('beforeunload', () => {
            if (countdownInterval) clearInterval(countdownInterval);
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>

</html>
