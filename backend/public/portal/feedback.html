<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="feedback_title">E-Claw - My Feedback</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶û</text></svg>">
    <link rel="stylesheet" href="shared/style.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        /* Submit form section */
        .submit-section {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .submit-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .submit-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .category-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* Category cards */
        .category-cards {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .cat-card {
            flex: 1;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cat-card:hover {
            border-color: var(--text-secondary);
        }

        .cat-card .cat-icon {
            font-size: 22px;
            margin-bottom: 6px;
        }

        .cat-card .cat-label {
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .cat-card.selected-bug {
            border-color: #F44336;
            border-width: 2px;
            background: rgba(244, 67, 54, 0.1);
        }
        .cat-card.selected-bug .cat-label {
            color: #F44336;
            font-weight: 600;
        }

        .cat-card.selected-feature {
            border-color: #2196F3;
            border-width: 2px;
            background: rgba(33, 150, 243, 0.1);
        }
        .cat-card.selected-feature .cat-label {
            color: #2196F3;
            font-weight: 600;
        }

        .cat-card.selected-question {
            border-color: #9C27B0;
            border-width: 2px;
            background: rgba(156, 39, 176, 0.1);
        }
        .cat-card.selected-question .cat-label {
            color: #9C27B0;
            font-weight: 600;
        }

        .submit-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            background: var(--input-bg);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .submit-textarea:focus {
            outline: none;
            border-color: var(--warning);
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--warning);
            color: #000;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Submit result */
        .submit-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--success);
            background: var(--card);
            display: none;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .result-header .check {
            color: var(--success);
            font-size: 18px;
            font-weight: bold;
        }

        .result-header .title {
            color: var(--success);
            font-size: 15px;
            font-weight: 600;
        }

        .result-detail {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .result-links {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .result-link-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--card-border);
            background: var(--card);
            text-decoration: none;
            color: var(--warning);
            transition: border-color 0.2s;
        }

        .result-link-card:hover {
            border-color: var(--warning);
            text-decoration: none;
        }

        .result-link-card .link-icon {
            font-size: 16px;
        }

        .result-link-card .link-text {
            flex: 1;
        }

        .result-link-card .link-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--warning);
        }

        .result-link-card .link-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .result-link-card .link-arrow {
            color: var(--text-muted);
        }

        /* Section divider */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .section-divider h3 {
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }

        .section-divider .line {
            flex: 1;
            height: 1px;
            background: var(--card-border);
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid var(--card-border);
            background: var(--card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--warning);
            color: var(--text);
        }

        .filter-btn.active {
            background: var(--warning);
            color: #000;
            border-color: var(--warning);
            font-weight: 600;
        }

        /* Feedback card */
        .feedback-card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        .feedback-card:hover {
            border-color: var(--warning);
        }

        .feedback-top-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-bug {
            background: rgba(244, 67, 54, 0.15);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .badge-feature {
            background: rgba(33, 150, 243, 0.15);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .badge-question {
            background: rgba(156, 39, 176, 0.15);
            color: #9C27B0;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        .badge-severity {
            font-size: 11px;
            font-weight: 500;
        }

        .severity-critical { color: #F44336; }
        .severity-high { color: #FF9800; }
        .severity-medium { color: #FFC107; }
        .severity-low { color: #4CAF50; }

        .badge-status {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }

        .status-open {
            background: rgba(255, 210, 63, 0.15);
            color: var(--warning);
            border: 1px solid rgba(255, 210, 63, 0.3);
        }

        .status-resolved {
            background: rgba(76, 175, 80, 0.15);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-in_progress {
            background: rgba(33, 150, 243, 0.15);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .status-closed {
            background: rgba(102, 102, 102, 0.15);
            color: #888;
            border: 1px solid rgba(102, 102, 102, 0.3);
        }

        .feedback-id {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .feedback-date {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 8px;
        }

        .feedback-message {
            font-size: 14px;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .feedback-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .tag {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            color: var(--warning);
            border: 1px solid var(--warning);
            background: rgba(255, 210, 63, 0.1);
        }

        .feedback-issue-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            padding: 6px 12px;
            font-size: 13px;
            color: var(--warning);
            text-decoration: none;
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            background: var(--input-bg);
            transition: all 0.2s;
        }

        .feedback-issue-link:hover {
            border-color: var(--warning);
            background: rgba(255, 210, 63, 0.1);
            text-decoration: none;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Photo upload */
        .photo-section {
            margin-bottom: 16px;
        }

        .photo-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .photo-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .photo-add-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px dashed var(--card-border);
            background: var(--input-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-add-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .photo-previews {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .photo-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            color: #fff;
            border: none;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
        }

        .photo-preview .remove-btn:hover {
            background: #F44336;
        }

        .photo-upload-status {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Photo thumbnails in feedback cards */
        .feedback-photos {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .feedback-photo-thumb {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .feedback-photo-thumb:hover {
            border-color: var(--warning);
        }

        .feedback-photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Photo lightbox */
        .photo-lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .photo-lightbox.active {
            display: flex;
        }

        .photo-lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .back-link {
            font-size: 14px;
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .back-link:hover {
            color: var(--warning);
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h2 data-i18n="feedback_title">My Feedback</h2>
            <a href="settings.html" class="back-link">&larr; Settings</a>
        </div>

        <!-- Submit new feedback section -->
        <div class="submit-section" id="submitSection">
            <h3 data-i18n="settings_feedback_title">Submit Feedback</h3>
            <div class="submit-desc" data-i18n="feedback_auto_log_hint">Logs from the last 5 minutes will be automatically captured to help diagnose the issue.</div>

            <div class="category-label" data-i18n="feedback_category_label">Category</div>
            <div class="category-cards">
                <div class="cat-card selected-bug" data-cat="bug" onclick="selectCategory('bug')">
                    <span class="cat-icon">üêõ</span>
                    <span class="cat-label" data-i18n="feedback_cat_bug">Bug</span>
                </div>
                <div class="cat-card" data-cat="feature" onclick="selectCategory('feature')">
                    <span class="cat-icon">üí°</span>
                    <span class="cat-label" data-i18n="feedback_cat_feature">Feature</span>
                </div>
                <div class="cat-card" data-cat="question" onclick="selectCategory('question')">
                    <span class="cat-icon">‚ùì</span>
                    <span class="cat-label" data-i18n="feedback_cat_question">Question</span>
                </div>
            </div>

            <textarea id="submitText" class="submit-textarea" placeholder="Describe the issue or suggestion..." data-i18n-placeholder="feedback_hint"></textarea>

            <!-- Photo upload -->
            <div class="photo-section">
                <div class="photo-label" data-i18n="feedback_photo_label">Attach Photos (Optional)</div>
                <div class="photo-hint" data-i18n="feedback_photo_hint">Add up to 5 photos to help illustrate the issue</div>
                <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp,image/gif" multiple style="display:none" onchange="onPhotosSelected(event)">
                <button type="button" class="photo-add-btn" id="photoAddBtn" onclick="document.getElementById('photoInput').click()">
                    üì∑ <span data-i18n="feedback_photo_add">Add Photos</span>
                </button>
                <div class="photo-previews" id="photoPreviews"></div>
                <div class="photo-upload-status" id="photoStatus"></div>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitFeedback()" data-i18n="settings_btn_send_feedback">Send</button>

            <!-- Result (shown after submit) -->
            <div class="submit-result" id="submitResult">
                <div class="result-header">
                    <span class="check">‚úì</span>
                    <span class="title" id="resultTitle"></span>
                </div>
                <div id="resultDetails"></div>
                <div class="result-links" id="resultLinks"></div>
            </div>
        </div>

        <!-- History section -->
        <div class="section-divider">
            <h3 data-i18n="feedback_history_title">My Feedback</h3>
            <div class="line"></div>
        </div>

        <!-- Filter bar -->
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all" onclick="filterFeedback('all')"
                data-i18n="feedback_filter_all">All</button>
            <button class="filter-btn" data-filter="bug" onclick="filterFeedback('bug')"
                data-i18n="feedback_cat_bug">Bug</button>
            <button class="filter-btn" data-filter="feature" onclick="filterFeedback('feature')"
                data-i18n="feedback_cat_feature">Feature</button>
            <button class="filter-btn" data-filter="question" onclick="filterFeedback('question')"
                data-i18n="feedback_cat_question">Question</button>
        </div>

        <!-- Loading state -->
        <div id="loadingState" class="loading-state" data-i18n="feedback_loading">Loading feedback...</div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state" style="display:none;">
            <h3 data-i18n="feedback_empty">No feedback submitted yet</h3>
            <p data-i18n="feedback_empty_sub">Your submitted feedback will appear here.</p>
        </div>

        <!-- Feedback list -->
        <div id="feedbackList"></div>
    </div>

    <!-- Photo lightbox -->
    <div class="photo-lightbox" id="photoLightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="Photo">
    </div>

    <!-- Shared scripts -->
    <script src="shared/api.js"></script>
    <script src="shared/nav.js"></script>
    <script src="shared/auth.js"></script>
    <script src="../shared/telemetry.js"></script>
    <script src="../shared/i18n.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="shared/socket.js"></script>
    <script src="shared/footer.js"></script>
    <script src="shared/ai-chat.js"></script>

    <script>
        let allFeedback = [];
        let currentFilter = 'all';
        let feedbackCategory = 'bug';
        // currentUser is declared in shared/auth.js
        let selectedPhotos = []; // File objects selected for upload

        window.addEventListener('DOMContentLoaded', async () => {
            renderNav('settings');
            if (typeof renderFooter === 'function') renderFooter();

            if (typeof i18n !== 'undefined') {
                i18n.apply();
            }

            const user = await checkAuth();
            if (!user) return;
            initPortalSocket();
            currentUser = user;

            loadFeedback(user);
        });

        function selectCategory(cat) {
            feedbackCategory = cat;
            document.querySelectorAll('.cat-card').forEach(card => {
                card.className = 'cat-card';
                if (card.dataset.cat === cat) {
                    card.classList.add('selected-' + cat);
                }
            });
        }

        // ============================================
        // PHOTO HANDLING
        // ============================================

        function onPhotosSelected(event) {
            const files = Array.from(event.target.files);
            const maxPhotos = 5;
            const maxSize = 5 * 1024 * 1024;

            for (const file of files) {
                if (selectedPhotos.length >= maxPhotos) break;
                if (file.size > maxSize) continue;
                if (!file.type.startsWith('image/')) continue;
                selectedPhotos.push(file);
            }

            // Reset input so same file can be re-selected
            event.target.value = '';
            renderPhotoPreviews();
        }

        function renderPhotoPreviews() {
            const container = document.getElementById('photoPreviews');
            const addBtn = document.getElementById('photoAddBtn');
            container.innerHTML = '';

            selectedPhotos.forEach((file, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'photo-preview';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.alt = file.name;
                wrap.appendChild(img);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    selectedPhotos.splice(idx, 1);
                    renderPhotoPreviews();
                };
                wrap.appendChild(removeBtn);
                container.appendChild(wrap);
            });

            // Hide add button if at max
            addBtn.style.display = selectedPhotos.length >= 5 ? 'none' : '';
        }

        async function uploadPhotos(feedbackId) {
            if (selectedPhotos.length === 0) return 0;

            const formData = new FormData();
            formData.append('deviceId', currentUser.deviceId);
            formData.append('deviceSecret', currentUser.deviceSecret);
            selectedPhotos.forEach(file => {
                formData.append('photos', file);
            });

            const resp = await fetch(`${API_BASE}/api/feedback/${feedbackId}/photos`, {
                method: 'POST',
                body: formData
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.message || 'Photo upload failed');
            return data.count || 0;
        }

        function openLightbox(url) {
            document.getElementById('lightboxImg').src = url;
            document.getElementById('photoLightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('photoLightbox').classList.remove('active');
            document.getElementById('lightboxImg').src = '';
        }

        // ============================================
        // SUBMIT FEEDBACK
        // ============================================

        async function submitFeedback() {
            const text = document.getElementById('submitText').value.trim();
            if (!text) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            const t = (key, fallback) => typeof i18n !== 'undefined' ? i18n.t(key) : fallback;
            btn.textContent = t('feedback_sending', 'Sending...');

            try {
                const result = await apiCall('POST', '/api/feedback', {
                    deviceId: currentUser.deviceId,
                    deviceSecret: currentUser.deviceSecret,
                    message: text,
                    category: feedbackCategory,
                    appVersion: 'web-portal',
                    source: 'web'
                });

                // Upload photos if any
                let photosUploaded = 0;
                if (selectedPhotos.length > 0 && result.feedbackId) {
                    const statusEl = document.getElementById('photoStatus');
                    statusEl.textContent = t('feedback_photo_uploading', 'Uploading photos...');
                    try {
                        photosUploaded = await uploadPhotos(result.feedbackId);
                        statusEl.textContent = t('feedback_photo_uploaded', photosUploaded + ' photo(s) uploaded').replace('%d', photosUploaded);
                    } catch (photoErr) {
                        statusEl.textContent = 'Photo upload failed: ' + photoErr.message;
                        statusEl.style.color = '#F44336';
                    }
                }

                btn.textContent = t('feedback_sent_short', 'Sent');
                btn.style.background = '#2E7D32';
                btn.style.color = '#fff';

                // Clear photo selection
                selectedPhotos = [];
                renderPhotoPreviews();

                showSubmitResult(result, photosUploaded);

                // Reload feedback list
                loadFeedback(currentUser);

                if (typeof telemetry !== 'undefined') {
                    telemetry.trackAction('send_feedback', { category: feedbackCategory, photos: photosUploaded });
                }
            } catch (e) {
                btn.disabled = false;
                btn.textContent = t('settings_btn_send_feedback', 'Send');
                btn.style.background = '';
                btn.style.color = '';
                if (typeof showToast === 'function') {
                    showToast('Failed: ' + e.message, 'error');
                }
            }
        }

        function showSubmitResult(result, photosUploaded) {
            const el = document.getElementById('submitResult');
            const t = (key, fallback) => typeof i18n !== 'undefined' ? i18n.t(key) : fallback;

            el.style.display = '';

            document.getElementById('resultTitle').textContent =
                t('feedback_result_title', 'Feedback #' + (result.feedbackId || '?') + ' received')
                    .replace('%d', result.feedbackId || '?');

            // Details
            const detailsEl = document.getElementById('resultDetails');
            detailsEl.innerHTML = '';

            if (result.severity) {
                const sevColor = { critical: '#F44336', high: '#FF9800', medium: '#FFC107', low: '#4CAF50' }[result.severity] || '#4CAF50';
                detailsEl.innerHTML += `<div class="result-detail" style="color:${sevColor}">${t('feedback_result_severity', 'Severity: ' + result.severity).replace('%s', result.severity)}</div>`;
            }

            if (result.logsCaptured) {
                const lc = result.logsCaptured;
                detailsEl.innerHTML += `<div class="result-detail">${t('feedback_result_logs', 'Captured: ' + lc.telemetry + ' API calls, ' + lc.serverLogs + ' server logs').replace('%d', lc.telemetry).replace('%d', lc.serverLogs)}</div>`;
            }

            if (result.tags && result.tags.length > 0) {
                let tagsHtml = '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">';
                result.tags.forEach(tag => {
                    tagsHtml += `<span class="tag">${escapeHtml(tag)}</span>`;
                });
                tagsHtml += '</div>';
                detailsEl.innerHTML += tagsHtml;
            }

            if (photosUploaded > 0) {
                detailsEl.innerHTML += `<div class="result-detail" style="margin-top:6px;">üì∑ ${t('feedback_photo_uploaded', photosUploaded + ' photo(s) uploaded').replace('%d', photosUploaded)}</div>`;
            }

            // Links
            const linksEl = document.getElementById('resultLinks');
            linksEl.innerHTML = '';

            if (result.githubIssue) {
                linksEl.innerHTML += `
                    <a href="${escapeHtml(result.githubIssue.url)}" target="_blank" class="result-link-card">
                        <span class="link-icon">‚äô</span>
                        <span class="link-text">
                            <div class="link-title">${t('feedback_result_issue', 'View GitHub Issue #' + result.githubIssue.number).replace('%d', result.githubIssue.number)}</div>
                            <div class="link-desc">${t('feedback_github_issue_desc', 'Track progress on GitHub')}</div>
                        </span>
                        <span class="link-arrow">‚Üí</span>
                    </a>`;
            }

            linksEl.innerHTML += `
                <a href="#feedbackList" class="result-link-card" onclick="document.getElementById('feedbackList').scrollIntoView({behavior:'smooth'});return false;">
                    <span class="link-icon">üìã</span>
                    <span class="link-text">
                        <div class="link-title">${t('feedback_track_title', 'Track Your Feedback')}</div>
                        <div class="link-desc">${t('feedback_track_desc', 'View the status and updates of your submitted feedback.')}</div>
                    </span>
                    <span class="link-arrow">‚Üí</span>
                </a>`;
        }

        async function loadFeedback(user) {
            const loadingEl = document.getElementById('loadingState');
            const emptyEl = document.getElementById('emptyState');
            const listEl = document.getElementById('feedbackList');

            loadingEl.style.display = '';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';

            try {
                const data = await apiCall('GET',
                    `/api/feedback?deviceId=${encodeURIComponent(user.deviceId)}&deviceSecret=${encodeURIComponent(user.deviceSecret)}&limit=100`
                );

                loadingEl.style.display = 'none';
                allFeedback = data.feedback || [];

                if (allFeedback.length === 0) {
                    emptyEl.style.display = '';
                } else {
                    renderFeedback();
                }
            } catch (e) {
                loadingEl.style.display = 'none';
                emptyEl.style.display = '';
                emptyEl.querySelector('h3').textContent = 'Failed to load: ' + e.message;
            }
        }

        function filterFeedback(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderFeedback();
        }

        function renderFeedback() {
            const listEl = document.getElementById('feedbackList');
            const emptyEl = document.getElementById('emptyState');
            listEl.innerHTML = '';

            const filtered = currentFilter === 'all'
                ? allFeedback
                : allFeedback.filter(f => f.category === currentFilter);

            if (filtered.length === 0) {
                emptyEl.style.display = '';
                return;
            }
            emptyEl.style.display = 'none';

            filtered.forEach(item => {
                listEl.appendChild(createFeedbackCard(item));
            });
        }

        function createFeedbackCard(item) {
            const card = document.createElement('div');
            card.className = 'feedback-card';

            const t = (key, fallback) => typeof i18n !== 'undefined' ? i18n.t(key) : fallback;

            // Category badge class
            const catClass = item.category === 'feature' ? 'badge-feature'
                : item.category === 'question' ? 'badge-question'
                : 'badge-bug';
            const catLabel = item.category === 'feature' ? t('feedback_cat_feature', 'Feature')
                : item.category === 'question' ? t('feedback_cat_question', 'Question')
                : t('feedback_cat_bug', 'Bug');

            // Severity class
            const sevClass = 'severity-' + (item.severity || 'low');

            // Status class and label
            const statusClass = item.status === 'resolved' ? 'status-resolved'
                : item.status === 'in_progress' ? 'status-in_progress'
                : item.status === 'closed' ? 'status-closed'
                : 'status-open';
            const statusLabel = item.status === 'resolved' ? t('feedback_status_resolved', 'Resolved')
                : item.status === 'in_progress' ? t('feedback_status_in_progress', 'In Progress')
                : item.status === 'closed' ? t('feedback_status_closed', 'Closed')
                : t('feedback_status_open', 'Open');

            // Format date
            const dateStr = formatDate(item.created_at);

            let html = `
                <div class="feedback-top-row">
                    <span class="badge ${catClass}">${catLabel}</span>
                    <span class="badge-severity ${sevClass}">${item.severity || 'low'}</span>
                    <span class="feedback-id">#${item.id}</span>
                    <span class="feedback-date">${dateStr}</span>
                    <span class="badge-status ${statusClass}">${statusLabel}</span>
                </div>
                <div class="feedback-message">${escapeHtml(item.message || '')}</div>
            `;

            // Tags
            if (item.tags && item.tags.length > 0) {
                html += '<div class="feedback-tags">';
                item.tags.forEach(tag => {
                    html += `<span class="tag">${escapeHtml(tag)}</span>`;
                });
                html += '</div>';
            }

            // GitHub issue link
            if (item.github_issue_url) {
                html += `<a href="${escapeHtml(item.github_issue_url)}" target="_blank" class="feedback-issue-link">‚äô ${t('feedback_view_issue', 'View GitHub Issue')} ‚Üí</a>`;
            }

            card.innerHTML = html;

            // Load photos asynchronously
            loadFeedbackPhotos(card, item.id);

            return card;
        }

        async function loadFeedbackPhotos(cardEl, feedbackId) {
            try {
                const data = await apiCall('GET',
                    `/api/feedback/${feedbackId}/photos?deviceId=${encodeURIComponent(currentUser.deviceId)}&deviceSecret=${encodeURIComponent(currentUser.deviceSecret)}`
                );
                if (data.photos && data.photos.length > 0) {
                    const photosDiv = document.createElement('div');
                    photosDiv.className = 'feedback-photos';
                    data.photos.forEach(photo => {
                        const thumb = document.createElement('div');
                        thumb.className = 'feedback-photo-thumb';
                        const img = document.createElement('img');
                        img.src = API_BASE + photo.url;
                        img.alt = photo.fileName || 'Photo';
                        img.loading = 'lazy';
                        thumb.onclick = () => openLightbox(API_BASE + photo.url);
                        thumb.appendChild(img);
                        photosDiv.appendChild(thumb);
                    });
                    // Insert before the tags or issue link
                    const tagsEl = cardEl.querySelector('.feedback-tags');
                    const issueEl = cardEl.querySelector('.feedback-issue-link');
                    const insertBefore = tagsEl || issueEl || null;
                    if (insertBefore) {
                        cardEl.insertBefore(photosDiv, insertBefore);
                    } else {
                        cardEl.appendChild(photosDiv);
                    }
                }
            } catch (e) {
                // Silently fail - photos are optional
            }
        }

        function formatDate(ts) {
            if (!ts) return '';
            try {
                const num = parseInt(ts);
                if (isNaN(num)) return ts;
                const d = new Date(num);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return ts;
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>

</html>
