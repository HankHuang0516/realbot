<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Claw Mission Control</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0D0D1A; color: #fff; min-height: 100vh; }

.header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #333355; }
.header h1 { font-size: 20px; }
.header .actions { display: flex; gap: 8px; }

.btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; transition: opacity 0.2s; }
.btn:hover { opacity: 0.85; }
.btn-primary { background: #6C63FF; color: #fff; }
.btn-outline { background: transparent; color: #aaa; border: 1px solid #555; }
.btn-small { padding: 4px 10px; font-size: 12px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.auth-panel { max-width: 400px; margin: 80px auto; padding: 32px; background: #1A1A2E; border-radius: 12px; border: 1px solid #333355; }
.auth-panel h2 { margin-bottom: 16px; font-size: 18px; }
.auth-panel input { width: 100%; padding: 10px 12px; margin-bottom: 12px; background: #252540; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 14px; }
.auth-panel input::placeholder { color: #666; }

.container { max-width: 900px; margin: 0 auto; padding: 16px; }

.card { background: #1A1A2E; border: 1px solid #333355; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.card-header h2 { font-size: 16px; }

.item { background: #252540; border-radius: 8px; padding: 10px; margin-bottom: 6px; cursor: pointer; transition: background 0.15s; }
.item:hover { background: #2E2E50; }
.item-row { display: flex; align-items: center; gap: 8px; }
.item-title { flex: 1; font-size: 14px; font-weight: 600; }
.item-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #333355; color: #aaa; }
.item-detail { color: #888; font-size: 12px; margin-top: 4px; }
.item-done { color: #4CAF50; font-size: 11px; margin-top: 4px; text-align: right; }

.empty { color: #555; font-size: 13px; text-align: center; padding: 20px; }

.sync-bar { text-align: right; color: #555; font-size: 11px; padding: 8px 0; }

.dialog-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; }
.dialog { background: #1A1A2E; border: 1px solid #444; border-radius: 12px; padding: 24px; min-width: 340px; max-width: 90vw; }
.dialog h3 { margin-bottom: 16px; }
.dialog input, .dialog textarea, .dialog select { width: 100%; padding: 8px 10px; margin-bottom: 10px; background: #252540; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 13px; }
.dialog textarea { min-height: 80px; resize: vertical; }
.dialog .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }

.context-menu { position: fixed; background: #252540; border: 1px solid #444; border-radius: 8px; padding: 4px 0; z-index: 200; min-width: 160px; }
.context-menu-item { padding: 8px 16px; cursor: pointer; font-size: 13px; }
.context-menu-item:hover { background: #333355; }

.switch { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
.switch input { opacity: 0; width: 0; height: 0; }
.switch .slider { position: absolute; inset: 0; background: #444; border-radius: 11px; cursor: pointer; transition: 0.3s; }
.switch .slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 2px; bottom: 2px; background: #888; border-radius: 50%; transition: 0.3s; }
.switch input:checked + .slider { background: #6C63FF; }
.switch input:checked + .slider::before { transform: translateX(18px); background: #fff; }
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen" class="auth-panel">
    <h2>Mission Control</h2>
    <p style="color:#888; margin-bottom:16px; font-size:13px;">Ëº∏ÂÖ•‰Ω†ÁöÑË£ùÁΩÆÊÜëË≠â‰æÜÂêåÊ≠• Dashboard</p>
    <input id="inputDeviceId" placeholder="Device ID" />
    <input id="inputDeviceSecret" placeholder="Device Secret" type="password" />
    <button class="btn btn-primary" style="width:100%" onclick="login()">ÈÄ£Á∑ö</button>
    <p id="authError" style="color:#f44; margin-top:8px; font-size:12px;"></p>
</div>

<!-- Dashboard Screen (hidden until auth) -->
<div id="dashboardScreen" style="display:none">
    <div class="header">
        <h1>Mission Control</h1>
        <div class="actions">
            <button class="btn btn-outline" onclick="downloadDashboard()">Refresh</button>
            <button class="btn btn-primary" id="btnSave" onclick="uploadDashboard()">Save to Cloud</button>
        </div>
    </div>

    <div class="container">
        <!-- TODO -->
        <div class="card">
            <div class="card-header">
                <h2>üìã TODO List</h2>
                <button class="btn btn-outline btn-small" onclick="showAddItem('todo')">+ Êñ∞Â¢û</button>
            </div>
            <div id="todoList"></div>
        </div>

        <!-- Mission -->
        <div class="card">
            <div class="card-header">
                <h2>üöÄ Mission List</h2>
            </div>
            <div id="missionList"></div>
        </div>

        <!-- Done -->
        <div class="card">
            <div class="card-header">
                <h2>‚úÖ Done List</h2>
            </div>
            <div id="doneList"></div>
        </div>

        <!-- Notes -->
        <div class="card">
            <div class="card-header">
                <h2>üìù Notes (Bot ÂîØËÆÄ)</h2>
                <button class="btn btn-outline btn-small" onclick="showAddNote()">+ Êñ∞Â¢û</button>
            </div>
            <div id="notesList"></div>
        </div>

        <!-- Rules -->
        <div class="card">
            <div class="card-header">
                <h2>üìú Rules (Workflow)</h2>
                <button class="btn btn-outline btn-small" onclick="showAddRule()">+ Êñ∞Â¢û</button>
            </div>
            <div id="rulesList"></div>
        </div>

        <div class="sync-bar" id="syncBar">-</div>
    </div>
</div>

<!-- Dialog container -->
<div id="dialogContainer"></div>
<!-- Context menu container -->
<div id="contextMenu" class="context-menu" style="display:none"></div>

<script>
const API_BASE = window.location.origin;
let deviceId = localStorage.getItem('mc_deviceId') || '';
let deviceSecret = localStorage.getItem('mc_deviceSecret') || '';
let dashboard = { todoList: [], missionList: [], doneList: [], notes: [], rules: [] };
let version = 1;
let hasChanges = false;
let refreshTimer = null;

// Priority labels
const PRIORITY_MAP = { 1: 'üü¢ ‰Ωé', 2: 'üü° ‰∏≠', 3: 'üü† È´ò', 4: 'üî¥ Á∑äÊÄ•' };
const STATUS_MAP = { PENDING: 'ÂæÖËôïÁêÜ', IN_PROGRESS: 'Âü∑Ë°å‰∏≠', BLOCKED: 'ÈòªÂ°û‰∏≠', DONE: 'ÂÆåÊàê', CANCELLED: 'Â∑≤ÂèñÊ∂à' };

// Auto-login if credentials exist
if (deviceId && deviceSecret) {
    document.getElementById('inputDeviceId').value = deviceId;
    document.getElementById('inputDeviceSecret').value = deviceSecret;
    login();
}

async function login() {
    deviceId = document.getElementById('inputDeviceId').value.trim();
    deviceSecret = document.getElementById('inputDeviceSecret').value.trim();
    if (!deviceId || !deviceSecret) { document.getElementById('authError').textContent = 'Ë´ãËº∏ÂÖ• Device ID Âíå Secret'; return; }

    try {
        const res = await fetch(`${API_BASE}/api/mission/dashboard?deviceId=${encodeURIComponent(deviceId)}&deviceSecret=${encodeURIComponent(deviceSecret)}`);
        const data = await res.json();
        if (!res.ok) { document.getElementById('authError').textContent = data.error || 'Authentication failed'; return; }
        if (!data.success) { document.getElementById('authError').textContent = data.error || 'Failed'; return; }

        localStorage.setItem('mc_deviceId', deviceId);
        localStorage.setItem('mc_deviceSecret', deviceSecret);

        applyDashboard(data.dashboard);
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';

        // Auto-refresh every 30s
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(downloadDashboard, 30000);
    } catch (e) {
        document.getElementById('authError').textContent = 'Connection error: ' + e.message;
    }
}

function applyDashboard(d) {
    dashboard = { todoList: d.todoList || [], missionList: d.missionList || [], doneList: d.doneList || [], notes: d.notes || [], rules: d.rules || [] };
    version = d.version || 1;
    hasChanges = false;
    renderAll();
}

async function downloadDashboard() {
    try {
        const res = await fetch(`${API_BASE}/api/mission/dashboard?deviceId=${encodeURIComponent(deviceId)}&deviceSecret=${encodeURIComponent(deviceSecret)}`);
        const data = await res.json();
        if (data.success && data.dashboard) { applyDashboard(data.dashboard); }
    } catch (e) { console.error('Refresh failed:', e); }
}

async function uploadDashboard() {
    const btn = document.getElementById('btnSave');
    btn.disabled = true; btn.textContent = 'Uploading...';
    try {
        const res = await fetch(`${API_BASE}/api/mission/dashboard`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deviceId, deviceSecret, version, dashboard })
        });
        const data = await res.json();
        if (data.success) {
            version = data.version || version + 1;
            hasChanges = false;
            renderSyncBar();
            btn.textContent = 'Save to Cloud';
        } else if (data.error === 'VERSION_CONFLICT') {
            if (confirm(`ÁâàÊú¨Ë°ùÁ™Å (‰Ω†: v${version}, ‰º∫ÊúçÂô®: v${data.currentVersion})„ÄÇ‰∏ãËºâÊúÄÊñ∞ÁâàÊú¨Ôºü`)) {
                await downloadDashboard();
            }
        } else {
            alert('Upload failed: ' + (data.error || 'Unknown'));
        }
    } catch (e) { alert('Error: ' + e.message); }
    btn.disabled = false;
    if (btn.textContent === 'Uploading...') btn.textContent = 'Save to Cloud';
}

function markChanged() { hasChanges = true; renderSyncBar(); }

function genId() { return crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2); }

function fmtDate(ts) { if (!ts) return '-'; const d = new Date(ts); return `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

// ========== Rendering ==========
function renderAll() {
    renderTodo(); renderMission(); renderDone(); renderNotes(); renderRules(); renderSyncBar();
}

function renderTodo() {
    const el = document.getElementById('todoList');
    if (!dashboard.todoList.length) { el.innerHTML = '<div class="empty">Â∞öÁÑ° TODO È†ÖÁõÆ</div>'; return; }
    el.innerHTML = dashboard.todoList.map(item => `
        <div class="item" onclick="showEditItem('${item.id}','todo')" oncontextmenu="showItemMenu(event,'${item.id}','todo')">
            <div class="item-row">
                <span>${(PRIORITY_MAP[item.priority?.value||item.priority]||'üü°').slice(0,2)}</span>
                <span class="item-title">${esc(item.title)}</span>
                <span class="item-badge">${STATUS_MAP[item.status?.name||item.status]||item.status||'ÂæÖËôïÁêÜ'}</span>
            </div>
            ${item.description ? `<div class="item-detail">${esc(item.description)}</div>` : ''}
        </div>`).join('');
}

function renderMission() {
    const el = document.getElementById('missionList');
    if (!dashboard.missionList.length) { el.innerHTML = '<div class="empty">Â∞öÁÑ°ÈÄ≤Ë°å‰∏≠ÁöÑ‰ªªÂãô</div>'; return; }
    el.innerHTML = dashboard.missionList.map(item => `
        <div class="item" onclick="showEditItem('${item.id}','mission')" oncontextmenu="showItemMenu(event,'${item.id}','mission')">
            <div class="item-row">
                <span>${(PRIORITY_MAP[item.priority?.value||item.priority]||'üü°').slice(0,2)}</span>
                <span class="item-title">${esc(item.title)}</span>
                <span class="item-badge">${STATUS_MAP[item.status?.name||item.status]||item.status||'Âü∑Ë°å‰∏≠'}</span>
            </div>
            <div class="item-detail">ü§ñ ${item.assignedBot||'-'} &nbsp; ‚è∞ ${item.eta ? fmtDate(item.eta) : '-'}</div>
        </div>`).join('');
}

function renderDone() {
    const el = document.getElementById('doneList');
    if (!dashboard.doneList.length) { el.innerHTML = '<div class="empty">Â∞öÁÑ°Â∑≤ÂÆåÊàêÈ†ÖÁõÆ</div>'; return; }
    el.innerHTML = dashboard.doneList.map(item => `
        <div class="item" oncontextmenu="showItemMenu(event,'${item.id}','done')">
            <div class="item-row">
                <span class="item-title">${esc(item.title)}</span>
            </div>
            ${item.completedAt ? `<div class="item-done">‚úì ${fmtDate(item.completedAt)}</div>` : ''}
        </div>`).join('');
}

function renderNotes() {
    const el = document.getElementById('notesList');
    if (!dashboard.notes.length) { el.innerHTML = '<div class="empty">Â∞öÁÑ°Á≠ÜË®ò</div>'; return; }
    el.innerHTML = dashboard.notes.map(n => `
        <div class="item" onclick="showEditNote('${n.id}')" oncontextmenu="showNoteMenu(event,'${n.id}')">
            <div class="item-row">
                <span class="item-title">${esc(n.title)}</span>
                <span class="item-badge">${esc(n.category||'general')}</span>
            </div>
            <div class="item-detail">${esc((n.content||'').slice(0,80))}</div>
        </div>`).join('');
}

function renderRules() {
    const el = document.getElementById('rulesList');
    if (!dashboard.rules.length) { el.innerHTML = '<div class="empty">Â∞öÁÑ°Ë¶èÂâá</div>'; return; }
    el.innerHTML = dashboard.rules.map(r => `
        <div class="item" onclick="showEditRule('${r.id}')" oncontextmenu="showRuleMenu(event,'${r.id}')">
            <div class="item-row">
                <span class="item-title">${esc(r.name)}</span>
                <span class="item-badge">${r.ruleType?.name||r.ruleType||''}</span>
                <label class="switch" onclick="event.stopPropagation()">
                    <input type="checkbox" ${r.isEnabled !== false ? 'checked' : ''} onchange="toggleRule('${r.id}')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="item-detail">${esc(r.description||'')}</div>
        </div>`).join('');
}

function renderSyncBar() {
    document.getElementById('syncBar').textContent = `v${version} | ${hasChanges ? '* Êú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥' : 'Â∑≤ÂêåÊ≠•'} | ${fmtDate(Date.now())}`;
    document.getElementById('btnSave').textContent = hasChanges ? 'Save to Cloud *' : 'Save to Cloud';
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

// ========== Dialogs ==========
function showDialog(title, fields, onSave) {
    const c = document.getElementById('dialogContainer');
    let html = `<div class="dialog-overlay" onclick="if(event.target===this)closeDialog()"><div class="dialog"><h3>${title}</h3>`;
    fields.forEach(f => {
        if (f.type === 'textarea') html += `<textarea id="dlg_${f.key}" placeholder="${f.label}">${esc(f.value||'')}</textarea>`;
        else if (f.type === 'select') html += `<select id="dlg_${f.key}">${f.options.map(o => `<option value="${o.value}" ${o.value==f.value?'selected':''}>${o.label}</option>`).join('')}</select>`;
        else html += `<input id="dlg_${f.key}" placeholder="${f.label}" value="${esc(f.value||'')}" />`;
    });
    html += `<div class="actions"><button class="btn btn-outline" onclick="closeDialog()">ÂèñÊ∂à</button><button class="btn btn-primary" id="dlgSaveBtn">ÂÑ≤Â≠ò</button></div></div></div>`;
    c.innerHTML = html;
    document.getElementById('dlgSaveBtn').onclick = () => { const vals = {}; fields.forEach(f => vals[f.key] = document.getElementById('dlg_'+f.key).value); onSave(vals); closeDialog(); };
}
function closeDialog() { document.getElementById('dialogContainer').innerHTML = ''; }

// Items
function showAddItem(list) {
    const priorityOpts = [{value:1,label:'üü¢ ‰Ωé'},{value:2,label:'üü° ‰∏≠'},{value:3,label:'üü† È´ò'},{value:4,label:'üî¥ Á∑äÊÄ•'}];
    showDialog('Êñ∞Â¢û TODO', [
        {key:'title', label:'Ê®ôÈ°å', value:''},
        {key:'description', label:'ÊèèËø∞', type:'textarea', value:''},
        {key:'priority', label:'ÂÑ™ÂÖàÊ¨ä', type:'select', value:2, options:priorityOpts}
    ], vals => {
        if (!vals.title.trim()) return;
        dashboard.todoList.push({id:genId(), title:vals.title.trim(), description:vals.description.trim(), priority:parseInt(vals.priority), status:'PENDING', createdAt:Date.now(), updatedAt:Date.now(), createdBy:'user'});
        markChanged(); renderTodo();
    });
}

function showEditItem(id, list) {
    const arr = list==='todo' ? dashboard.todoList : list==='mission' ? dashboard.missionList : dashboard.doneList;
    const item = arr.find(i => i.id === id); if (!item) return;
    const priorityOpts = [{value:1,label:'üü¢ ‰Ωé'},{value:2,label:'üü° ‰∏≠'},{value:3,label:'üü† È´ò'},{value:4,label:'üî¥ Á∑äÊÄ•'}];
    const pv = item.priority?.value || item.priority || 2;
    showDialog('Á∑®ËºØ', [
        {key:'title', label:'Ê®ôÈ°å', value:item.title},
        {key:'description', label:'ÊèèËø∞', type:'textarea', value:item.description},
        {key:'priority', label:'ÂÑ™ÂÖàÊ¨ä', type:'select', value:pv, options:priorityOpts}
    ], vals => {
        if (!vals.title.trim()) return;
        item.title = vals.title.trim(); item.description = vals.description.trim(); item.priority = parseInt(vals.priority); item.updatedAt = Date.now();
        markChanged(); renderAll();
    });
}

function showItemMenu(e, id, list) {
    e.preventDefault();
    const menu = document.getElementById('contextMenu');
    let items = [];
    if (list === 'todo') { items.push({label:'‚û°Ô∏è ÁßªËá≥ Mission', fn:()=>moveItem(id,'todo','mission')}); items.push({label:'‚úÖ Ê®ôË®òÂÆåÊàê', fn:()=>moveItem(id,'todo','done')}); }
    if (list === 'mission') { items.push({label:'‚úÖ Ê®ôË®òÂÆåÊàê', fn:()=>moveItem(id,'mission','done')}); }
    items.push({label:'üóëÔ∏è Âà™Èô§', fn:()=>deleteItem(id,list)});
    menu.innerHTML = items.map(i => `<div class="context-menu-item">${i.label}</div>`).join('');
    menu.style.display = 'block'; menu.style.left = e.clientX+'px'; menu.style.top = e.clientY+'px';
    menu.querySelectorAll('.context-menu-item').forEach((el,idx) => el.onclick = () => { items[idx].fn(); menu.style.display='none'; });
    setTimeout(() => document.addEventListener('click', () => menu.style.display='none', {once:true}), 10);
}

function moveItem(id, from, to) {
    const fromArr = from==='todo' ? dashboard.todoList : dashboard.missionList;
    const idx = fromArr.findIndex(i => i.id === id); if (idx < 0) return;
    const item = fromArr.splice(idx, 1)[0];
    item.updatedAt = Date.now();
    if (to === 'mission') { item.status = 'IN_PROGRESS'; dashboard.missionList.push(item); }
    if (to === 'done') { item.status = 'DONE'; item.completedAt = Date.now(); dashboard.doneList.unshift(item); }
    markChanged(); renderAll();
}

function deleteItem(id, list) {
    if (!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
    if (list==='todo') dashboard.todoList = dashboard.todoList.filter(i=>i.id!==id);
    else if (list==='mission') dashboard.missionList = dashboard.missionList.filter(i=>i.id!==id);
    else dashboard.doneList = dashboard.doneList.filter(i=>i.id!==id);
    markChanged(); renderAll();
}

// Notes
function showAddNote() {
    showDialog('Êñ∞Â¢ûÁ≠ÜË®ò', [
        {key:'title', label:'Ê®ôÈ°å', value:''},
        {key:'content', label:'ÂÖßÂÆπ', type:'textarea', value:''},
        {key:'category', label:'ÂàÜÈ°û', value:'general'}
    ], vals => {
        if (!vals.title.trim()) return;
        dashboard.notes.push({id:genId(), title:vals.title.trim(), content:vals.content.trim(), category:vals.category.trim()||'general', createdAt:Date.now(), updatedAt:Date.now(), createdBy:'user'});
        markChanged(); renderNotes();
    });
}

function showEditNote(id) {
    const note = dashboard.notes.find(n => n.id === id); if (!note) return;
    showDialog('Á∑®ËºØÁ≠ÜË®ò', [
        {key:'title', label:'Ê®ôÈ°å', value:note.title},
        {key:'content', label:'ÂÖßÂÆπ', type:'textarea', value:note.content},
        {key:'category', label:'ÂàÜÈ°û', value:note.category}
    ], vals => {
        if (!vals.title.trim()) return;
        note.title = vals.title.trim(); note.content = vals.content.trim(); note.category = vals.category.trim()||'general'; note.updatedAt = Date.now();
        markChanged(); renderNotes();
    });
}

function showNoteMenu(e, id) {
    e.preventDefault();
    const menu = document.getElementById('contextMenu');
    menu.innerHTML = '<div class="context-menu-item">üóëÔ∏è Âà™Èô§</div>';
    menu.style.display = 'block'; menu.style.left = e.clientX+'px'; menu.style.top = e.clientY+'px';
    menu.querySelector('.context-menu-item').onclick = () => { if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')){dashboard.notes=dashboard.notes.filter(n=>n.id!==id);markChanged();renderNotes();} menu.style.display='none'; };
    setTimeout(() => document.addEventListener('click', () => menu.style.display='none', {once:true}), 10);
}

// Rules
function showAddRule() {
    const typeOpts = ['WORKFLOW','CODE_REVIEW','COMMUNICATION','DEPLOYMENT','SYNC'].map(t=>({value:t,label:t}));
    showDialog('Êñ∞Â¢ûË¶èÂâá', [
        {key:'name', label:'Ë¶èÂâáÂêçÁ®±', value:''},
        {key:'description', label:'Ë™™Êòé', type:'textarea', value:''},
        {key:'ruleType', label:'È°ûÂûã', type:'select', value:'WORKFLOW', options:typeOpts}
    ], vals => {
        if (!vals.name.trim()) return;
        dashboard.rules.push({id:genId(), name:vals.name.trim(), description:vals.description.trim(), ruleType:vals.ruleType, isEnabled:true, priority:0, config:{}, createdAt:Date.now(), updatedAt:Date.now()});
        markChanged(); renderRules();
    });
}

function showEditRule(id) {
    const rule = dashboard.rules.find(r => r.id === id); if (!rule) return;
    const typeOpts = ['WORKFLOW','CODE_REVIEW','COMMUNICATION','DEPLOYMENT','SYNC'].map(t=>({value:t,label:t}));
    const rt = rule.ruleType?.name || rule.ruleType || 'WORKFLOW';
    showDialog('Á∑®ËºØË¶èÂâá', [
        {key:'name', label:'Ë¶èÂâáÂêçÁ®±', value:rule.name},
        {key:'description', label:'Ë™™Êòé', type:'textarea', value:rule.description},
        {key:'ruleType', label:'È°ûÂûã', type:'select', value:rt, options:typeOpts}
    ], vals => {
        if (!vals.name.trim()) return;
        rule.name = vals.name.trim(); rule.description = vals.description.trim(); rule.ruleType = vals.ruleType; rule.updatedAt = Date.now();
        markChanged(); renderRules();
    });
}

function toggleRule(id) {
    const rule = dashboard.rules.find(r => r.id === id); if (!rule) return;
    rule.isEnabled = !rule.isEnabled; rule.updatedAt = Date.now();
    markChanged();
}

function showRuleMenu(e, id) {
    e.preventDefault();
    const menu = document.getElementById('contextMenu');
    menu.innerHTML = '<div class="context-menu-item">üóëÔ∏è Âà™Èô§</div>';
    menu.style.display = 'block'; menu.style.left = e.clientX+'px'; menu.style.top = e.clientY+'px';
    menu.querySelector('.context-menu-item').onclick = () => { if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')){dashboard.rules=dashboard.rules.filter(r=>r.id!==id);markChanged();renderRules();} menu.style.display='none'; };
    setTimeout(() => document.addEventListener('click', () => menu.style.display='none', {once:true}), 10);
}
</script>
</body>
</html>
